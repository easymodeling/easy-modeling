name: RELEASE

on:
  push:
    tags:
      - '*'

env:
  OSSRH_USERNAME: 'OSSRH_USERNAME'
  OSSRH_PASSWORD: 'OSSRH_PASSWORD'

jobs:
  ci:
    uses: ./.github/workflows/ci.yml
    secrets: inherit

  version:
    name: Check Artifacts Version
    runs-on: ubuntu-latest
    needs:
      - ci
    steps:
      - name: 'Checkout repository'
        uses: actions/checkout@v2
      - uses: ./.github/actions/set-up-jdk
      - name: 'Compare gradle version to git tag'
        shell: bash
        run: |
          GRADLE_VERSION=$(./gradlew properties -q | grep "version:" | awk '{print $2}')
          GIT_TAG=${GITHUB_REF#refs/*/}
          [[ "${GRADLE_VERSION}" == "${GIT_TAG}" ]]
      - name: 'Release version'
        id: release-version
        run: echo "::set-output name=RELEASE_VERSION::${GITHUB_REF#refs/*/}"
    outputs:
      RELEASE_VERSION: ${{ steps.release-version.outputs.RELEASE_VERSION }}

  release-draft:
    name: "Release Draft"
    runs-on: ubuntu-latest
    needs:
      - version
    if: ${{ !endsWith(needs.version.outputs.RELEASE_VERSION, '-SNAPSHOT') }}
    steps:
      - name: 'Create release draft'
        uses: ncipollo/release-action@v1
        with:
          draft: true
          prerelease: true
          token: ${{ github.token }}

  snapshot:
    name: Publish Snapshot Artifact
    runs-on: ubuntu-latest
    environment: maven-central-snapshot
    timeout-minutes: 10
    needs:
      - version
    env:
      OSSRH_USERNAME: ${{secrets.OSSRH_USERNAME}}
      OSSRH_PASSWORD: ${{secrets.OSSRH_PASSWORD}}
      OSSRH_URL: ${{secrets.OSSRH_URL}}
    steps:
      - name: 'Checkout repository'
        uses: actions/checkout@v2
      - uses: ./.github/actions/set-up-jdk
      - uses: ./.github/actions/publish-artifact
        with:
          signing-secret-key-ring-b64: ${{ secrets.SIGNING_SECRET_KEY_RING_B64 }}
          signing-key-id: ${{ secrets.SIGNING_KEY_ID }}
          signing-key-password: ${{ secrets.SIGNING_KEY_PASSWORD }}

  verify-snapshot-artifact:
    name: Verify Snapshot Artifact
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs:
      - snapshot
    steps:
      - name: 'Checkout repository'
        uses: actions/checkout@v2
      - uses: actions/setup-java@v2
        with:
          java-version: '8'
          distribution: 'zulu'
      - name: 'Run test with new released artifact snapshot'
        run: ./gradlew clean -Partifact-verification :artifact-verification:build

  release:
    name: Publish Release Artifact
    runs-on: ubuntu-latest
    timeout-minutes: 10
    environment: maven-central-release
    needs:
      - version
    if: ${{ !endsWith(needs.version.outputs.RELEASE_VERSION, '-SNAPSHOT') }}
    env:
      OSSRH_USERNAME: ${{secrets.OSSRH_USERNAME}}
      OSSRH_PASSWORD: ${{secrets.OSSRH_PASSWORD}}
      OSSRH_URL: ${{secrets.OSSRH_URL}}
    steps:
      - name: 'Checkout repository'
        uses: actions/checkout@v2
      - uses: ./.github/actions/set-up-jdk
      - uses: ./.github/actions/publish-artifact
        with:
          signing-secret-key-ring-b64: ${{ secrets.SIGNING_SECRET_KEY_RING_B64 }}
          signing-key-id: ${{ secrets.SIGNING_KEY_ID }}
          signing-key-password: ${{ secrets.SIGNING_KEY_PASSWORD }}
